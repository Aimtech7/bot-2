const _0x27b176=_0x1c70;(function(_0x5ec832,_0x213831){const _0xc2954c=_0x1c70,_0x44ea7d=_0x5ec832();while(!![]){try{const _0xb7439f=parseInt(_0xc2954c(0x1ac))/(-0x1b7f+-0x1a63+-0x1bd*-0x1f)*(parseInt(_0xc2954c(0x1a8))/(-0x1d65+-0xa7b*0x1+0x27e2))+-parseInt(_0xc2954c(0x181))/(-0x2*0x5cb+0xd98+-0x1ff)*(-parseInt(_0xc2954c(0x1b1))/(0x32d+-0x2*-0x120b+-0x273f))+-parseInt(_0xc2954c(0x174))/(-0x1*-0x59b+-0x102+-0x494)+-parseInt(_0xc2954c(0x1a4))/(0x2471+0x1769+-0x3bd4)*(-parseInt(_0xc2954c(0x15b))/(0x17a1+-0x3cc+-0x13ce))+parseInt(_0xc2954c(0x155))/(-0xbe3*-0x3+-0x1672+-0xd2f)+parseInt(_0xc2954c(0x177))/(-0x1*-0x29+-0x2383+0x2363)+-parseInt(_0xc2954c(0x1b3))/(-0x74f+-0xde2+0x153b)*(parseInt(_0xc2954c(0x16b))/(-0x1287+-0x1*-0x10c1+-0x1*-0x1d1));if(_0xb7439f===_0x213831)break;else _0x44ea7d['push'](_0x44ea7d['shift']());}catch(_0x5ae8c7){_0x44ea7d['push'](_0x44ea7d['shift']());}}}(_0x2dff,0x9*-0x29ee3+-0x3*0x63059+-0x1c127e*-0x2));import{info,warn,error}from'../utils/logger.js';import{db}from'../utils/database.js';import{userJidFromCtx as _0x72fde2}from'../utils/sudo.js';export const name=_0x27b176(0x16d);export const version=_0x27b176(0x163);export const priority=-0x1*0x83d+-0x1*-0x8b7+0x9*-0xd;let botInstance=null,cleanupInterval=null;function _0x2dff(){const _0x4000dc=['id,\x20saved_','sage_sende','t_pn','2hIvzfa','\x20);','s\x20WHERE\x20ms','isArray','206381yNPOab','\x20IN\x20(','\x20old\x20sende','er,\x20chat_j','\x20failed:\x20','52AbyVAY','EXISTS\x20mes','1810cwvITX','key','essage_sen','CLEANUP_IN','Old\x20error:','length','exec','r]\x20attache','rror:\x20','replace','remoteJidA','9810872mAIxfA','erForMsg\x20e','nder_jid\x20T','g_id\x20=\x20?','er\x20TEXT,\x0a\x20','M\x20message_','7TREHJK','ender_numb','psert:\x20','e\x20requires','msg_id','join','MINUTES',',\x20saved_at','1.0.1','toLowerCas','participan','O\x20message_','TERVAL_MS','sage\x20handl','string','\x20bot\x20arg','103543cZLRoB','r]\x20cleanup','sudonumber','message','tAlt','messages.u','d\x20to\x20messa','\x20initializ','jid','2089070TtFjuc','ERE\x20msg_id','derIfMissi','12110184TPuQfM','L\x20AND\x20save','rs\x20(\x0a\x20\x20\x20\x20m','to\x20attach\x20','CREATE\x20TAB','slice',',\x20?,\x20?,\x20?,','r]\x20initial','sg_id\x20TEXT','EY,\x0a\x20\x20\x20\x20se','59277NGjqSq','find','indexOf','\x20?)','run','[sudonumbe','d\x20TEXT,\x0a\x20\x20','r]\x20per-mes','map','r]\x20failed\x20','ener','\x20PRIMARY\x20K','SELECT\x20msg','\x20FROM\x20mess','get','r_jid,\x20sen','\x20\x20\x20chat_ji','RETENTION_','dler\x20error','r]\x20DB\x20init','ng\x20failed:','at)\x0a\x20\x20\x20\x20\x20\x20','r]\x20cleaned','IGNORE\x20INT','lid','der_number','catch','INSERT\x20OR\x20','d_at\x20<\x20?','ized','floor','er\x20error:\x20','r]\x20getSend','function','EXT,\x0a\x20\x20\x20\x20s','20196KooEbq'];_0x2dff=function(){return _0x4000dc;};return _0x2dff();}const FALLBACKS={'RETENTION_MINUTES':0xf,'CLEANUP_INTERVAL_MS':(0x1909+0x109f*-0x1+-0x82e)*(-0x1*-0x1d03+0x2*0xaa7+-0x2e69)};let RETENTION_MINUTES=FALLBACKS[_0x27b176(0x192)+_0x27b176(0x161)],CLEANUP_INTERVAL_MS=FALLBACKS[_0x27b176(0x14d)+'TERVAL_MS'];function nowSeconds(){const _0x3a50d5=_0x27b176;return Math[_0x3a50d5(0x19f)](Date['now']()/(0x1509+-0x1b20+-0x1*-0x9ff));}async function ensureTable(){const _0x42963d=_0x27b176;await db[_0x42963d(0x150)](_0x42963d(0x17b)+'LE\x20IF\x20NOT\x20'+_0x42963d(0x1b2)+_0x42963d(0x1a6)+_0x42963d(0x179)+_0x42963d(0x17f)+_0x42963d(0x18c)+_0x42963d(0x180)+_0x42963d(0x157)+_0x42963d(0x1a3)+_0x42963d(0x15c)+_0x42963d(0x159)+_0x42963d(0x191)+_0x42963d(0x187)+'\x20\x20saved_at'+'\x20INTEGER\x0a\x20'+_0x42963d(0x1a9));}function normalizeNumberFromSudoJid(_0x327f52){const _0x31e1e7=_0x27b176;if(!_0x327f52)return'';try{const _0x56d063=String(_0x327f52),_0x206e46=_0x56d063[_0x31e1e7(0x183)]('@'),_0x2270c4=_0x206e46===-(-0x7ed+0xe5f+-0x671)?_0x56d063:_0x56d063['slice'](0x1477+-0x6a*-0xd+-0x19d9,_0x206e46),_0x1a078d=_0x2270c4[_0x31e1e7(0x183)](':'),_0x257c2e=_0x1a078d===-(0x48b*-0x1+-0x7a2+0xc2e)?_0x2270c4:_0x2270c4[_0x31e1e7(0x17c)](0x580+0x29*-0x41+0x4e9,_0x1a078d);return _0x257c2e[_0x31e1e7(0x153)](/^\+/,'');}catch{return String(_0x327f52||'');}}async function saveSenderIfMissing(_0x5ba640,_0x28b333,_0x54f895){const _0x219e57=_0x27b176;if(!_0x5ba640||!_0x28b333)return![];const _0x42d7bd=normalizeNumberFromSudoJid(_0x28b333),_0x5617f3=nowSeconds();try{return await db[_0x219e57(0x185)](_0x219e57(0x19c)+_0x219e57(0x198)+_0x219e57(0x166)+'senders\x20(m'+'sg_id,\x20sen'+'der_jid,\x20s'+_0x219e57(0x15c)+_0x219e57(0x1af)+_0x219e57(0x1a5)+_0x219e57(0x196)+'\x20VALUES\x20(?'+_0x219e57(0x17d)+_0x219e57(0x184),[_0x5ba640,_0x28b333,_0x42d7bd||null,_0x54f895||null,_0x5617f3]),!![];}catch(_0x54969d){return warn(_0x219e57(0x186)+'r]\x20saveSen'+_0x219e57(0x176)+_0x219e57(0x195)+'\x20'+(_0x54969d?.[_0x219e57(0x16e)]||_0x54969d)),![];}}export async function getSenderForMsg(_0x37f69a){const _0x4d843e=_0x27b176;if(!_0x37f69a)return null;try{const _0x1e17a5=await db[_0x4d843e(0x18f)](_0x4d843e(0x18d)+'_id,\x20sende'+_0x4d843e(0x190)+_0x4d843e(0x19a)+',\x20chat_jid'+_0x4d843e(0x162)+_0x4d843e(0x18e)+'age_sender'+_0x4d843e(0x1aa)+_0x4d843e(0x158),[_0x37f69a]);return _0x1e17a5||null;}catch(_0x5373dc){return warn(_0x4d843e(0x186)+_0x4d843e(0x1a1)+_0x4d843e(0x156)+_0x4d843e(0x152)+(_0x5373dc?.[_0x4d843e(0x16e)]||_0x5373dc)),null;}}async function cleanupOld(){const _0x499b49=_0x27b176;try{const _0x112ba0=nowSeconds()-Number(RETENTION_MINUTES||FALLBACKS['RETENTION_'+_0x499b49(0x161)])*(0x1*0x1ce4+-0x10d5*-0x1+-0x2d7d),_0xd6bfb5=await db['all'](_0x499b49(0x18d)+'_id\x20FROM\x20m'+_0x499b49(0x1b5)+'ders\x20WHERE'+'\x20saved_at\x20'+'IS\x20NOT\x20NUL'+_0x499b49(0x178)+_0x499b49(0x19d),[_0x112ba0]);if(!_0xd6bfb5||_0xd6bfb5['length']===-0x2612+0x5*-0x155+0x2cbb)return;const _0x548ff6=_0xd6bfb5[_0x499b49(0x189)](_0x5ceb48=>_0x5ceb48[_0x499b49(0x15f)]),_0x1b9b70=-0x1*0xd88+-0x219f*0x1+0x2fef;for(let _0x4fda2c=0x742+0x9*-0x2ef+0x179*0xd;_0x4fda2c<_0x548ff6[_0x499b49(0x14f)];_0x4fda2c+=_0x1b9b70){const _0x156204=_0x548ff6[_0x499b49(0x17c)](_0x4fda2c,_0x4fda2c+_0x1b9b70),_0x1d88e2=_0x156204['map'](()=>'?')[_0x499b49(0x160)](',');await db['run']('DELETE\x20FRO'+_0x499b49(0x15a)+'senders\x20WH'+_0x499b49(0x175)+_0x499b49(0x1ad)+_0x1d88e2+')',_0x156204);}info(_0x499b49(0x186)+_0x499b49(0x197)+'\x20'+_0xd6bfb5['length']+(_0x499b49(0x1ae)+'r\x20rows'));}catch(_0x18a683){warn(_0x499b49(0x186)+_0x499b49(0x16c)+_0x499b49(0x14e)+'\x20'+(_0x18a683?.[_0x499b49(0x16e)]||_0x18a683));}}function _0x1c70(_0x22e22d,_0x108989){const _0xb4467c=_0x2dff();return _0x1c70=function(_0x57a1f0,_0x25a2c0){_0x57a1f0=_0x57a1f0-(-0x1916+0xb10+0x1*0xf53);let _0x3a5306=_0xb4467c[_0x57a1f0];return _0x3a5306;},_0x1c70(_0x22e22d,_0x108989);}async function messagesUpsertHandler({messages:_0x54d575}){const _0x5aed27=_0x27b176;try{if(!_0x54d575||!Array[_0x5aed27(0x1ab)](_0x54d575))return;for(const _0x118d5d of _0x54d575){try{if(!_0x118d5d||!_0x118d5d[_0x5aed27(0x1b4)])continue;if(_0x118d5d[_0x5aed27(0x1b4)]['fromMe'])continue;const _0x4edb8b=_0x118d5d['key']?.['id']||_0x118d5d['id']||_0x118d5d[_0x5aed27(0x16e)]&&_0x118d5d[_0x5aed27(0x16e)][_0x5aed27(0x1b4)]&&_0x118d5d[_0x5aed27(0x16e)][_0x5aed27(0x1b4)]['id']||null;if(!_0x4edb8b)continue;const _0x259582=await getSenderForMsg(_0x4edb8b);if(_0x259582)continue;let _0x5b2ac5=[];try{const _0x4f52d3=_0x72fde2(_0x118d5d);_0x5b2ac5=_0x4f52d3&&Array[_0x5aed27(0x1ab)](_0x4f52d3['findings'])?_0x4f52d3['findings']:[];}catch(_0x23525a){warn(_0x5aed27(0x186)+'r]\x20userjid'+'\x20threw:\x20'+(_0x23525a?.['message']||_0x23525a)),_0x5b2ac5=[];}if(!_0x5b2ac5[_0x5aed27(0x14f)])continue;const _0x21eb9a=[_0x5aed27(0x154)+'lt','sender_pn',_0x5aed27(0x165)+_0x5aed27(0x16f),'participan'+_0x5aed27(0x1a7)];let _0x3eac6a=null;for(const _0x28435b of _0x21eb9a){_0x3eac6a=_0x5b2ac5[_0x5aed27(0x182)](_0x3a58b1=>_0x3a58b1['field']===_0x28435b&&typeof _0x3a58b1['jid']===_0x5aed27(0x169));if(_0x3eac6a)break;}if(!_0x3eac6a)_0x3eac6a=_0x5b2ac5[0x10a1+-0x2*0x1b1+-0xd3f];if(!_0x3eac6a||!_0x3eac6a[_0x5aed27(0x173)]||typeof _0x3eac6a[_0x5aed27(0x173)]!==_0x5aed27(0x169))continue;const _0x3930c2=_0x3eac6a['jid']['indexOf']('@'),_0x20baf1=_0x3930c2===-(-0xec9+0x1f5*0xc+-0x8b2*0x1)?'':_0x3eac6a[_0x5aed27(0x173)][_0x5aed27(0x17c)](_0x3930c2+(-0x79f*0x1+-0x1527+-0x1*-0x1cc7));if(!_0x20baf1||_0x20baf1[_0x5aed27(0x164)+'e']()===_0x5aed27(0x199))continue;await saveSenderIfMissing(_0x4edb8b,_0x3eac6a[_0x5aed27(0x173)],_0x118d5d[_0x5aed27(0x1b4)]?.['remoteJid']||null);}catch(_0x4cc0c7){warn(_0x5aed27(0x186)+_0x5aed27(0x188)+_0x5aed27(0x168)+_0x5aed27(0x1a0)+(_0x4cc0c7?.['message']||_0x4cc0c7));}}}catch(_0x15b453){warn('[sudonumbe'+'r]\x20message'+'sUpsertHan'+_0x5aed27(0x193)+':\x20'+(_0x15b453?.[_0x5aed27(0x16e)]||_0x15b453));}}export async function initialize(_0x489bf3){const _0x35d49b=_0x27b176;if(!_0x489bf3)throw new Error('sudonumber'+_0x35d49b(0x172)+_0x35d49b(0x15e)+_0x35d49b(0x16a));botInstance=_0x489bf3,await ensureTable()[_0x35d49b(0x19b)](_0x23271e=>{const _0x11e3f1=_0x35d49b;error(_0x23271e,_0x11e3f1(0x186)+_0x11e3f1(0x194)+_0x11e3f1(0x1b0)+(_0x23271e?.[_0x11e3f1(0x16e)]||_0x23271e));throw _0x23271e;});try{botInstance['on'](_0x35d49b(0x170)+'psert',messagesUpsertHandler),info(_0x35d49b(0x186)+_0x35d49b(0x151)+_0x35d49b(0x171)+'ges.upsert');}catch(_0x56e5bf){warn(_0x35d49b(0x186)+_0x35d49b(0x18a)+_0x35d49b(0x17a)+'messages.u'+_0x35d49b(0x15d)+(_0x56e5bf?.[_0x35d49b(0x16e)]||_0x56e5bf));}if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=setInterval(cleanupOld,Number(CLEANUP_INTERVAL_MS||FALLBACKS['CLEANUP_IN'+_0x35d49b(0x167)])),info(_0x35d49b(0x186)+_0x35d49b(0x17e)+_0x35d49b(0x19e));}export async function cleanup(){const _0x1fd034=_0x27b176;try{if(botInstance&&typeof botInstance['removeList'+_0x1fd034(0x18b)]===_0x1fd034(0x1a2))botInstance['removeList'+_0x1fd034(0x18b)](_0x1fd034(0x170)+'psert',messagesUpsertHandler);if(cleanupInterval)clearInterval(cleanupInterval);cleanupInterval=null;}catch(_0x13d2fa){warn(_0x1fd034(0x186)+_0x1fd034(0x16c)+'\x20error:\x20'+(_0x13d2fa?.[_0x1fd034(0x16e)]||_0x13d2fa));}finally{botInstance=null;}}export default{'name':name,'version':version,'initialize':initialize,'cleanup':cleanup,'getSenderForMsg':getSenderForMsg};